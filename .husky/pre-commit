#!/bin/sh
set -e

# Load nvm if available
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Skip hooks on feature branches (only enforce on main/master/dev)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "main" ] && [ "$BRANCH" != "master" ] && [ "$BRANCH" != "dev" ]; then
  echo "â„¹ï¸  Skipping pre-commit checks on feature branch: $BRANCH"
  exit 0
fi

echo "ğŸš€ Running pre-commit checks (fast local validation)..."

# 1. Run linting and type checking (fast)
echo "ğŸ“ Running linting..."
npm run lint

echo "ğŸ” Running type checking..."
npm run check

# 2. Run unit tests only (fast)
echo "ğŸ§ª Running unit tests..."
npm test

# 3. Security audit (high severity only)
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high || {
  echo "âš ï¸  High severity security vulnerabilities found!"
  echo "Run 'npm audit' for details or 'npm audit fix' to fix automatically"
  exit 1
}

echo "âœ… Pre-commit checks passed! (Docker validation and deployment tests run in CI)"
